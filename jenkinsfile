pipeline {
  agent any
  
  stages {
    stage('Install Terraform') {
      steps {
        script {
          // Install Terraform on the EC2 instance using the dynamic IP
          sh "ssh -i /./ jenkinsKeyPair.ppk ec2-user@52.91.55.34 'sudo yum install -y yum-utils'"
          sh "ssh -i /./ jenkinsKeyPair.ppk ec2-user@52.91.55.34 'sudo yum-config-manager --add-repo https://rpm.releases.hashicorp.com/AmazonLinux/hashicorp.repo'"
          sh "ssh -i /./ jenkinsKeyPair.ppk ec2-user@52.91.55.34 'sudo yum -y install terraform'"
          sh "ssh -i /./ jenkinsKeyPair.ppk ec2-user@52.91.55.34 'sudo mv terraform /usr/local/bin/'"
          sh "ssh -i /./ jenkinsKeyPair.ppk ec2-user@52.91.55.34 'terraform --version'"
        }
      }
    }
    
    stage('Clone GitHub Repo') {
      steps {
        script {
          // Clone your GitHub repository on the EC2 instance using the dynamic IP
          sh "ssh -i /./ jenkinsKeyPair.ppk ec2-user@52.91.55.34 'git clone https://github.com/AbhiGupta8295/devops_project.git'"
        }
      }
    }
    
    stage('Run Terraform') {
      steps {
        script {
          // Run Terraform commands on the EC2 instance using the dynamic IP
          sh "ssh -i /./ jenkinsKeyPair.ppk ec2-user@52.91.55.34 'cd devops_project && terraform init'"
          sh "ssh -i /./ jenkinsKeyPair.ppk ec2-user@52.91.55.34 'cd devops_project && terraform plan'"
          sh "ssh -i /./ jenkinsKeyPair.ppk ec2-user@52.91.55.34 'cd devops_project && terraform apply -auto-approve'"
        }
      }
    }
  }
}
